#!/bin/sh

# Author:     Héctor Molinero Fernández <hector@molinero.xyz>
# Repository: https://github.com/hectorm/music-dl
# License:    MIT, https://opensource.org/licenses/MIT

set -eu

TMP_DIR=$(mktemp -dt music-dl.XXXXXXXX)
OUT_DIR="${HOME}/Downloads/Music"

printAction() {
	printf -- '\033[1;33m + \033[1;32m%s \033[0m\n' "$@"
}

mkdir "${TMP_DIR}"/before "${TMP_DIR}"/after

printAction 'Downloading...'
youtube-dl \
	--default-search 'ytsearch' \
	--format 'bestaudio' \
	--output "${TMP_DIR}/before/%(title)s" \
	-- "$@"

printAction 'Encoding to VBR MP3...'
for file in "${TMP_DIR}/before"/*; do
	ffmpeg \
		-hide_banner \
		-i "$file" \
		-codec:a libmp3lame \
		-qscale:a 2 \
		"${TMP_DIR}/after/${file##*/}.mp3"
done

if command -v eyeD3 >/dev/null; then
	printAction 'Cleaning metadata using eyeD3...'
	eyeD3 --remove-all "${TMP_DIR}"/after/*.mp3
elif command -v id3convert >/dev/null; then
	printAction 'Cleaning metadata using id3lib...'
	id3convert --strip "${TMP_DIR}"/after/*.mp3
elif command -v mat >/dev/null; then
	printAction 'Cleaning metadata using MAT...'
	mat "${TMP_DIR}"/after/*.mp3
fi

printAction 'Moving to output folder...'
mkdir -p "${OUT_DIR}"
mv -f "${TMP_DIR}"/after/*.mp3 "${OUT_DIR}"

printAction 'Removing temp files...'
rm -rf "${TMP_DIR}"
